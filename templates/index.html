<!DOCTYPE html>
    <html> 
    {% include 'header.html' %}
        <!--  page-wrapper -->
        <div id="page-wrapper">

            <div class="row" >
                <!-- Page Header -->
                <div class="col-md-12" style="margin-top: -18px;">
                    <h1 class="page-header">DashBoard</h1>
                </div>
                <!--End Page Header -->
            </div>

            <div class="row">
                <!--quick info section -->
                <div class="col-md-8">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <i class="fa fa-cloud" id ="city" aria-hidden="true"></i>
                            <!--<p id="city"></p>-->
                            <div class="pull-right">
                                <div class="btn-group">
                                    <button type="button" onclick="reloadWeather()" class="btn btn-default btn-xs btn-success" >Refresh
                                        <span class="fa fa-refresh" aria-hidden="true"></span>
                                    </button>
                                    
                                </div>
                            </div>
                        </div>

                        <div class="panel-body">
                            <div height="180" id=divMeteo>
                                <iframe id="frame" width="540" height="220"  frameborder="0"></iframe>
                                <!--<iframe id="frame" src="" width="540" height="180" ///// src="https://embed.windytv.com/embed2.html?lat=48.4909&lon=-4.5737&type=forecast&metricWind=km%2Fh&metricTemp=%C2%B0C" /////////frameborder="0"></iframe>-->
                            </div>
                        </div>

                    </div>
                        
                </div>
                <div class="col-md-4" id="id_alert" data-alert={{session['alert']}} >
                    <div class="alert alert-danger text-center">
                        <i class="fa fa-dashboard fa-3x" onclick="alertUpdate()"></i>
                            <!--<button type="button" onclick="changeParam('range',1)" class="btn btn-default btn-xs btn-success" >Refresh
                                <span class="fa fa-refresh" aria-hidden="true"></span>
                            </button>-->
                            <div id="text_alert"></div>

                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-info text-center">
                        <i class="fa fa-cloud-download fa-3x" data-toggle="modal" data-target="#myModal" onclick="checkUpdate()"></i>
                        <h4>Chercher une mise à jours</h4>
                        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                            <h4 class="modal-title" id="myModalLabel"></h4>
                                        </div>
                                        <div class="modal-body" id="updateInfo">
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" id="btn_maj" class="btn btn-primary"> OK</button>
                                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                    </div>
                </div>
                
                <!--end quick info section -->
            </div>
        </div>
        <!-- end page-wrapper -->
    </div>
    <!-- end wrapper -->

    <!-- Core Scripts - Include with every page -->
    <script src="static/plugins/jquery-1.10.2.js"></script>
    <script src="static/plugins/bootstrap/bootstrap.min.js"></script>
    <script src="static/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="static/plugins/pace/pace.js"></script>
    <script src="static/scripts/siminta.js"></script>
    <!-- Page-Level Plugin Scripts-->
    <script src="static/plugins/morris/raphael-2.1.0.min.js"></script>
    <script src="static/plugins/morris/morris.js"></script>
    <script src="static/scripts/dashboard-demo.js"></script>


<script  type="text/javascript">
    window.onload = initDashboard

    function initDashboard(){
        alertUpdate()
        reloadWeather()
    }

    function reloadWeather(){
        var req = new XMLHttpRequest()
            req.onreadystatechange = function(){
                if (req.readyState == 4){
                        var response = JSON.parse(req.responseText)
                        if(response.CITY == 0){
                            document.getElementById('city').innerHTML = " error"
                            $("#frame").attr("src", "static/ifrm.htm");
                        }else{
                            document.getElementById('city').innerHTML = response.CITY
                            $("#frame").attr("src", "https://embed.windytv.com/embed2.html?lat="+response.LAT+"&lon="+response.LONG+"&type=forecast&metricWind=km%2Fh&metricTemp=%C2%B0C");
                        }
            }}
            req.open('POST', '/weather')
            req.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
            var postVars = 'username=1'
            req.send(postVars)
        return false
    }


    function alertUpdate(){
        var req = new XMLHttpRequest()
            req.onreadystatechange = function(){
                if (req.readyState == 4){
                        var response = JSON.parse(req.responseText)
                        console.log = response.alert
                        document.getElementById('text_alert').innerHTML = response.alert

            }}
            req.open('POST', '/alertUpdate')
            req.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
            var postVars = 'username=1'
            req.send(postVars)
        return false
    }




    function checkUpdate(){
        var req = new XMLHttpRequest()
            req.onreadystatechange = function(){
                if (req.readyState == 4){
                        var response = JSON.parse(req.responseText)
                        if(response.out == "True"){
                            document.getElementById('myModalLabel').innerHTML = "Système à jour"
                            document.getElementById('updateInfo').innerHTML = "Aucune mise à jour disponible"
                            document.getElementById('btn_maj').style.visibility = 'hidden';
                        }else{
                            document.getElementById('myModalLabel').innerHTML = "Mise à jour disponible"
                            document.getElementById('updateInfo').innerHTML = "Cliquer sur OK pour mettre à jour le système. Attention cela nécessite un redémarrage complet du système, certaine donnée pourraient etre perdu. "
                            document.getElementById('btn_maj').style.visibility = 'visible';
                        } 
            }}
        
            req.open('POST', '/update')
            req.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
            var postVars = 'username=1'
            req.send(postVars)
        return false
    }

</script>
</body>
</html>





